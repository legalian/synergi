


{% extends "template.html" %}
{% set active_page = "editor" %}
{% import "components.html" as components %}

{% block body %}
{{components.importscripts()}}
{{components.importDivider()}}
{{components.importTabs()}}
{{components.importTextArea()}}
{{components.importHtmlArea()}}
{{components.importRecursiveArea()}}

<div data-bind="template:{name:node.template,data:node,afterRender:node.onLoad}" style="height:100%"></div>

<script src="static/script/synchronize.js"></script>
<!-- add leading, following for batching changes, eliminate whitespace right off the bat. list of ignored changes -->

<script type='text/html' id='right-pane'>
  Connected Users:
  <div data-bind="foreach:$root.activeusers">
    <div data-bind="style:{color:color},text:name"></div>
  </div>
  Editor:
  <select data-bind="options:$root.availableeditors,optionsText: 'name',optionsValue: 'func',"></select>
</script>

<script type='text/html' id='add-split-tab'>
  <div style="position:relative;height:100%;width:100%;">
    <div data-bind="template:{name:'tabs-area',data:$data,afterRender:onLoad}"></div>
    <div style="position:absolute;top:0;right:0;bottom:0;width:2em;background-color:black;">
      <i class="material-icons littleplus" data-bind="click:$root.extradd,clickBubble:false">add</i>
    </div>
  </div>
</script>



<script>

function shuffle(a) {
  var j, x, i;
  for (i = a.length - 1; i > 0; i--) {
    j = Math.floor(Math.random() * (i + 1));
    x = a[i];
    a[i] = a[j];
    a[j] = x;
  }
  return a;
}
var COLORS = shuffle([
  '#e21400', '#91580f', '#f8a700', '#f78b00',
  '#58dc00', '#287b00', '#a8f07a', '#4ae8c4',
  '#3b88eb', '#3824aa', '#a700ff', '#d300e7'
]);
var colori = 0;




var justice;







// EDITOR
// selected file ->
//   select each tab


// DUAL EDITOR
// selected file1 ->
// selected file2 ->




function TextEditor(currentfile) {
  var self  = this;
  self.name = "Text Editor";
  self.node = new TextArea();
  self.sync = null
  self.suspend = function(paneui) {
    if (paneui()==self) {
      if (self.sync!=null) {self.sync.disableUI();}
      paneui(null);
    }
  }
  self.wake = function(paneui) {
    console.log("waking");
    self.sync = currentfile.format(RawTextDataFormat,function(sync){
      self.sync = sync;
      paneui(self);
      self.sync.attach(self.node.editor);
    });
  }
}

function GenericUI() {
  // self.connectedFiles = [];
  // self.desiredFormats = [];
  // self.specificwake = function(syncs) {};

  self.suspend = function(paneui) {
    if (paneui()==self) {
      self.connectedFiles.forEach(function(item){
        item.uiBecameInactive(ui);
      });
      paneui(null);
    }
  }
  self.wake = function(paneui) {
    var eachfileconnected = [];
    self.connectedFiles.forEach(function(item,index){
      eachfileconnected.push(null);
      item.format(self.desiredFormats[index],function(sync){
        eachfileconnected[index]=sync;
        if (eachfileconnected.every(a=>a!=null)) {
          self.specificwake(eachfileconnected);
          paneui(self);
        }
      });
    });
  }

  // self.connectedSyncs = 
}
// function DualTextEditor(currentfile) {
//   var self  = this;
//   self.name = "Text Editor";
//   self.node = new TextArea();
//   self.sync = null
//   self.suspend = function() {
//     if (justice.ui()==self) {
//       if (self.sync!=null) {self.sync.disableUI();}
//       justice.ui(null);
//     }
//   }
//   self.wake = function() {
//     console.log("waking");
//     var onewoke=false;
//     var twowoke=false;
//     function getwoke(){

//     }
//     self.sync = currentfile.format(RawTextDataFormat,function(sync){
//       self.sync = sync;
//       justice.ui(self);
//       self.sync.attach(self.node.editor);
//     });
//     self.sync = currentfile.format(RawTextDataFormat,function(sync){
//       self.sync = sync;
//       justice.ui(self);
//       self.sync.attach(self.node.editor);
//     });
//   }
// }


// function AnimationEditor() {
//   var self = this;
//   self.name = "Animation Editor";
//   self.node = new TextArea();

// }
// function MusicEditor() {
//   var self = this;
//   self.name = "Music Editor";
//   self.node = new TextArea();

// }




function RawTextDataFormat(data) {
  return SyncObservable.fromObservable({str:false},ko.observable(data));
}

//last pane interacted with...
//always add tab to rightmost/ select on rightmost...


function RightPane() {
  var self = this;
  self.template = "right-pane";
  self.vresize = function() {}
  self.onLoad = function() {}
}
function AddSplitTab(props) {
  var self = this;
  Tabs.bind(self)(props)
  self.template = "add-split-tab";
  self.downgrade = function(){
    self.template = "tabs-area";
  }
}
function Pane() {
  var self = this;
  self.tabs = ko.observableArray([]);
  self.selected = ko.observable();
  self.ui = ko.observable(null);
  self.onClick = function(item) {
    item.active(self.ui);
  }
  self.onRemove = function(item) {
    item.removeListener(self);
  }
  Divider.bind(self)({
    type:"fixed-top",
    initialmeasure:"2em",
    resizeable:true,
    first:ko.observable(new AddSplitTab({draggroup:"GEditorTabs",tabs:self.tabs,closeable:true,rearrangeable:true,selected:self.selected,onClick:self.onClick,onRemove:self.onRemove})),
    second:ko.computed(function(){
      if (self.ui()==null) {return justice.blank;}
      return self.ui().node;
    })
  });
  self.closeEverything
}




function Directory(data){
  var self = this;
  self.type = 'tree';
  self.title = data.title;
  self.path = data.path;
  self.elems = ko.observableArray([]);
  self.expanded = ko.observable(true);
  self.radd = function(ra) {
    ra.title = ra.title.substr(ra.title.indexOf('/')+1);
    if (ra.title.indexOf('/') == -1) {
      if (ra.type == 'blob') {
        self.elems.push(new File(ra));
      } else if (ra.type == 'tree') {
        self.elems.push(new Directory(ra));
      }
    } else {
      self.elems()[self.elems().length-1].radd(ra);
    }
  }
  self.open = function(){}
}
function File(data) {
  var self = this;
  self.type = 'blob';
  self.title = data.title;
  self.path = data.path;
  self.sha = data.sha;
  self.connectedusers = ko.observableArray([]);


  self.centraldata    = null
  self.listeners      = []//[([ui],synchronizer)]<--- synchronizer.dataformat
  self.connectedpanes = []//[(pane,ui)]


  //any change in synchronizer should update other synchronizers and shared bank and server

  self.transferPanes = function(pane1,pane2) {
    self.removePane(pane2);
    //any uis connected to pane1 are now connected to pane2.
    //any uis already connected to pane2 should be closed.
  }
  self.personalUiChanged = function(pane,newui) {
    self.connectedpanes.forEach(function(item) {
      if (item.pane == pane) {
        //

      }
    });
  }
  self.removePane = function(pane) {
    var foundind = -1;
    self.connectedpanes.forEach(function(item,index) {
      if (item.pane == pane) {
        item.ui.suspend(pane.ui);
        foundind = index;
      }
    });
    if (foundind != -1) {self.connectedpanes.splice(foundind,1);}
    //find the pane and kill it and then kill the associated ui and the associated synchronizer
  }
  self.uiBecameInactive = function(ui) {
    //might need to call sync.disableUI
    //then you might just throw away your synchronizer.
  }


  self.format = function(format,callback) {
    //format current data in accordance with given format. called anytime relevant UIs wake.
    //call callback with 
    if (self.lastdataformat==format) {callback(self.synchronizer);return;}
    self.lastdataformat = format;
    if (self.synchronizer==null) {
      $.ajax("/files", {
        type: "POST",
        data: ko.toJSON({
          sessionId:justice.sessionId,
          path:self.path
        }),
        contentType: "application/json",
        success: function(data){
          self.synchronizer = format(data);
          self.synchronizer.synchronize(justice.sessionId,self.path);
          callback(self.synchronizer);
        }
      });
    } else {
      self.synchronizer.disconnect();
      self.synchronizer = format(self.synchronizer.evaluate());
      self.synchronizer.synchronize(justice.sessionId,self.path);
      callback(self.synchronizer);
    }
  }
  self.close = function() {//tab closed; unload all related data.
    if (self.ui!=null) {self.ui.suspend();}
    self.synchronizer = null;
    self.lastdataformat = null;
    self.ui = null;
  }
  self.active = function(ui) {
    if (self.ui == null) {self.ui = new TextEditor(self);}
    if (ui()!=self.ui) {
      if (ui()!=null) {ui().suspend();}
      self.ui.wake(ui);
    }
  }
  self.open = function(){
    var pane = justice.getFrontPane();

    if (!pane.first().tabs().includes(self)) {
      pane.first().tabs.push(self);
    }
    pane.first().selected(self);
    self.active(pane.ui);

    
  }
}
function User(data) {
  self.name = data;
  self.color = COLORS[colori];
  colori = (colori+1)%12;
}
function AppViewModel(servedata) {
  var self =  this;
  self.elems = ko.observableArray([]);
  // self.tabs  = ko.observableArray([]);


  self.activeusers = ko.observableArray(servedata['activemembers'].split(",").map(function(item){return new User(item);}));
  self.sessionId = servedata.sessionId


  socket.on('player_join', function(data){self.activeusers.push(data.name);});
  socket.on('player_leave',function(data){self.activeusers.remove(data.name);});


  self.ui = ko.observable(null);
  self.selected = ko.observable(null);
  self.blank = new HtmlArea({html:""});

  self.availableeditors = ko.observableArray([{name:"Text Editor",func:TextEditor}]);//,{name:"Double Text Editor",func:DualTextEditor}
  self.reqeditor = ko.observable(self.availableeditors()[0]);
  self.reqeditor.subscribe(function(neditor){
    if (self.selected()!=null) {self.selected().form();}
  });


  self.node = new Divider({
    type:"fixed-left",
    resizeable:true,
    first:ko.observable(new RecursiveArea({elems:self.elems,onClick:function(item){item.open();}})),
    second:ko.observable(new Divider({
      type:"fixed-right",
      resizeable:true,
      first:ko.observable(new Divider({
        type:"fixed-top",
        initialmeasure:"2em",
        resizeable:true,
        first:ko.observable(new AddSplitTab({draggroup:"GEditorTabs",tabs:ko.observableArray([]),closeable:true,rearrangeable:true,selected:ko.observable()})),
        second:ko.computed(function(){
          if (self.ui()==null) {
            return self.blank;
          }
          return self.ui().node;
        })
      })),
      second:ko.observable(new RightPane())
    }))
  });
  self.getFrontPane = function() {
    if (self.node.second().first().first().template == "resizeable-area") {
      return self.node.second().first().second();
    } else {
      return self.node.second().first();
    }
  }
  self.paneCount = function() {
    return self.countPanes(self.node.second().first());
  }
  self.countPanes = function(eds) {
    if (eds.first().template == "resizeable-area") {
      return 1 + self.countPanes(eds.first())
    } else {
      return 1
    }
  }
  self.extradd = function() {
    console.log("adding tab; there are now(before the add):",self.paneCount(),"tabs")
    var allprevs = self.node.second().first();
    var newfirst = new Divider({
      type:"fixed-top",
      initialmeasure:"2em",
      resizeable:true,
      first:ko.observable(new AddSplitTab({draggroup:"GEditorTabs",tabs:ko.observableArray([]),closeable:true,rearrangeable:true,selected:ko.observable()})),
      second:ko.computed(function(){
        if (self.ui()==null) {return self.blank;}
        return self.ui().node;
      })
    })
    var newcombination = new Divider({
      type:"fixed-right",
      resizeable:true,
      first:ko.observable(allprevs),
      second:ko.observable(newfirst),
      slidesout:true,
      parent:function(cheat){
        var mast;
        if (cheat.first().template=='resizeable-area') {mast = cheat.second().first();}
        else {mast = cheat.first();}
        mast.template = "add-split-tab";
        mast.downgrade = function(){mast.template = "tabs-area";}
        self.node.second().first(cheat);
      }
    });
    if (allprevs.first().template=='add-split-tab') {allprevs.first().downgrade();}
    else {allprevs.second().first().downgrade();}
    allprevs.reparent(newcombination.first);
    self.node.second().first(newcombination)
  }
  $.ajax("/directories", {
    type: "POST",
    contentType: "application/json",
    data: ko.toJSON({
      sessionId:self.sessionId
    }),
    success: function(data){
      data.tree.forEach(function(ra){
        ra.title = ra.path;
        if (ra.title.indexOf('/') == -1) {
          if (ra.type == 'blob') {
            self.elems.push(new File(ra));
          } else if (ra.type == 'tree') {
            self.elems.push(new Directory(ra));
          }
        } else {
          self.elems()[self.elems().length-1].radd(ra);
        }
      });
    }
  });
}



handshake(function(servedata){
  justice = new AppViewModel(servedata);
  ko.applyBindings(justice);
});







</script>

<!-- 
<<<<<<< HEAD
<div id="editormain">
	<div id="editleft" data-bind="template: {name:'layerNode',foreach:children}">
	</div>
	<div id="editorcenter">
		<div data-bind="foreach: tabs" id="tabbar">
			<div data-bind="click:click,text:title,class:$root.activefile()==$data?'activetab':'tab'"></div>
		</div>
		<div id="editor"></div>
	</div>
	<div id="editright" data-bind="foreach:activeusers">
		<div class="userbox" data-bind="style: { color: color}">
			<div data-bind="text:name"></div>
		</div>
	</div>
</div>


<script src="static/script/editorjs.js"></script>

=======
>>>>>>> f7ebc47cb140a786e3841aa03e45ec83cddab9b6 -->
{% endblock %}
{% block footer %}
{% endblock %}




